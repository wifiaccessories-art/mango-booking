<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Manage Booking</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg-top:#fff7d6;
      --bg-bottom:#e2f8da;
      --card:#ffffff;
      --text:#123027;
      --muted:#6d7a7a;
      --accent:#ff9b21;
      --accent-dark:#d67400;
      --accent-soft:#ffe0a8;
      --input-bg:#f5f8fa;
      --border:#dde4ec;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      min-height:100vh;
      font:16px/1.5 system-ui,Segoe UI,Roboto,Helvetica,Arial;
      color:var(--text);
      background:
        radial-gradient(circle at 10% 0%, #ffe6aa 0, transparent 65%),
        radial-gradient(circle at 90% 100%, #c2f1b5 0, transparent 60%),
        linear-gradient(180deg,var(--bg-top),var(--bg-bottom));
    }
    .wrap{
      max-width:1100px;
      margin:24px auto 40px;
      padding:12px;
      position:relative;
      z-index:2;
    }

    .decor{display:none;}

    .card{
      position:relative;
      z-index:2;
      background:var(--card);
      border-radius:26px;
      border:1px solid rgba(0,0,0,.04);
      box-shadow:0 18px 40px rgba(0,0,0,.18);
      overflow:hidden;
      width:100%;
    }

    /* -------- HEADER WITH HERO IMAGE ---------- */
    header{
      padding:22px 26px 16px;
      background:linear-gradient(135deg,#ffe6b5,#ffe0a0,#ffb347);
      border-bottom:1px solid rgba(0,0,0,.06);
      display:flex;
      gap:18px;
      align-items:center;
    }

    .header-left{
      display:flex;
      gap:14px;
      align-items:center;
      flex:1;
      min-width:0;
    }

    header .emoji{
      font-size:34px;
      flex-shrink:0;
    }

    .header-text{
      flex:1;
      min-width:0;
    }

    .header-text h1{
      margin:0 0 4px;
      font-size:26px;
      color:#3b1f00;
    }

    .header-text p{
      margin:0;
      color:#5c3b11;
      font-size:14px;
      max-width:420px;
    }

    .header-right{
      margin-left:auto;
      text-align:right;
      font-size:12px;
      color:#5c3b11;
    }
    .header-right span{display:block;}

    .header-hero{
      flex-shrink:0;
    }
    .header-hero img{
      display:block;
      max-width:260px;
      border-radius:22px;
      box-shadow:0 10px 24px rgba(0,0,0,.28);
    }

    main{
      padding:18px 26px 24px;
      background:#fff;
    }

    .section{margin-top:18px}
    .section h3{
      margin:0 0 8px;
      font-size:18px;
      color:#18412b;
    }
    .grid2{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:12px 16px;
    }
    .grid3{
      display:grid;
      grid-template-columns:1fr 1fr 1fr;
      gap:12px 16px;
    }

    
#deliveryAddressWrap{grid-column:1 / -1;}
label{
      font-weight:600;
      font-size:13px;
      margin:8px 0 6px;
      display:block;
      color:#1c4330;
    }

    input:not([type="radio"]):not([type="checkbox"]),
    select,
    textarea{
      width:100%;
      padding:11px 12px;
      border-radius:12px;
      border:1px solid var(--border);
      background:var(--input-bg);
      color:var(--text);
      outline:none;
      font-size:14px;
      transition:border-color .15s, box-shadow .15s, background .15s;
    }
    input:not([type="radio"]):not([type="checkbox"]):focus,
    select:focus,
    textarea:focus{
      border-color:var(--accent);
      box-shadow:0 0 0 2px rgba(255,155,33,.35);
      background:#ffffff;
    }

    input[type="radio"],
    input[type="checkbox"]{
      width:auto;
      padding:0;
      margin:0;
      border:none;
      background:transparent;
      box-shadow:none;
      accent-color:#ff9b21;
      transform:scale(1.05);
    }
    input[type="radio"]:focus,
    input[type="checkbox"]:focus{
      outline:2px solid rgba(255,155,33,.6);
      outline-offset:2px;
      box-shadow:none;
    }

    small.hint{
      color:var(--muted);
      display:block;
      margin-top:4px;
      font-size:11px;
    }
    .mini{font-size:12px;color:var(--muted)}

    .actions{
      display:flex;
      gap:12px;
      margin-top:16px;
      align-items:center;
      flex-wrap:wrap;
    }
    button{
      cursor:pointer;
      border:0;
      border-radius:999px;
      padding:11px 18px;
      font-weight:700;
      line-height:1;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      font-size:14px;
      letter-spacing:.01em;
    }
    .primary{
      background:linear-gradient(135deg,#ff9b21,#ffb347);
      color:#3b1f00;
      box-shadow:0 6px 18px rgba(255,155,33,.45);
    }
    .primary:active{
      transform:translateY(1px);
      box-shadow:0 3px 10px rgba(255,155,33,.4);
    }
    .ghost{
      background:#fff7e5;
      color:#7a4a0d;
      border:1px solid:#ffcf7c;
    }
    .danger{
      background:#ffe3df;
      border:1px solid:#f5b0a7;
      color:#9b2b21;
      padding-inline:10px;
      border-radius:12px;
      font-size:13px;
    }

    .success,.error{
      margin:10px 0 0;
      border-radius:12px;
      padding:10px 12px;
      font-weight:600;
      white-space:pre-wrap;
      font-size:13px;
    }
    .success{
      background:#e3f4e7;
      border:1px solid #b7dfbf;
      color:#166736;
    }
    .error{
      background:#fde7e4;
      border:1px solid #f0b2aa;
      color:#b32819;
    }
    .req{color:#c25200}
    .muted{color:var(--muted)}
    .hidden{display:none}
    .thankyou{
      padding:44px 24px 40px;
      text-align:center;
    }
    .thankyou h2{
      margin-top:0;
      color:#18412b;
    }
    .thankyou-img{
      margin-top:20px;
      max-width:260px;
      width:100%;
      border-radius:22px;
      box-shadow:0 12px 26px rgba(0,0,0,.25);
    }
    .hr{
      height:1px;
      background:#edf1f6;
      margin:14px 0;
    }

    .items-wrap{
      width:100%;
      overflow-x:auto;
      -webkit-overflow-scrolling:touch;
      border-radius:16px;
      border:1px solid #e4ebf2;
      background:#fbfcfe;
      margin-top:6px;
    }
    table.items{
      width:100%;
      min-width:480px;
      border-collapse:collapse;
    }
    table.items th,
    table.items td{
      border-bottom:1px solid #edf1f6;
      padding:8px 10px;
      font-size:13px;
    }
    table.items th{
      font-weight:600;
      text-align:left;
      background:#f6fafc;
      color:#355656;
    }
    table.items th:nth-child(4),
    table.items td:nth-child(4){
      text-align:right;
      padding-right:16px;
    }
    table.items th:nth-child(5),
    table.items td:nth-child(5){
      width:40px;
      text-align:center;
      padding-right:8px;
      padding-left:4px;
    }

    /* -------- RADIO GROUPS ---------- */
    .option-group{
      margin-top:6px;
      padding-left:0;
      display:flex;
      flex-direction:column;
      align-items:flex-start;
      gap:4px;
      width:100%;
      max-width:520px;
    }
    .option-group .choice{
      display:flex;
      align-items:center;
      gap:8px;
      margin:0;
      padding:0;
    }
    .option-group .label-text{
      flex:1;
      font-size:14px;
      color:#38534a;
    }
    @media (min-width:769px){
      .option-group .label-text{
        white-space:nowrap;
      }
    }

    #submitBtn{
      width:auto;
      padding:11px 26px;
      font-size:15px;
    }
    #submitBtn:disabled{opacity:.6}

    @media (max-width:1024px){
      .wrap{margin:16px auto 28px;padding:8px}
    }

    @media (max-width:768px){
      .wrap{margin:8px auto 24px;padding:6px}
      .card{border-radius:20px;}
      header{
        padding:18px 18px 12px;
        flex-direction:column;
        align-items:flex-start;
      }
      .header-left{
        align-items:flex-start;
      }
      .header-right{
        margin-left:0;
        margin-top:6px;
        text-align:left;
      }
      .header-hero{
        align-self:stretch;
        text-align:center;
        margin-top:10px;
      }
      .header-hero img{
        max-width:240px;
        width:100%;
        margin:0 auto;
      }
      main{padding:16px 18px 20px}
      .grid2{grid-template-columns:1fr}
      .grid3{grid-template-columns:1fr 1fr}
      .actions{flex-direction:column;align-items:stretch}
      #submitBtn{width:100%;justify-content:center}
      .option-group{max-width:100%;}
      .option-group .label-text{white-space:normal;}
    }

    @media (max-width:520px){
      main{padding:14px 14px 18px}
      .header-text h1{font-size:22px}
      .grid3{grid-template-columns:1fr}
      table.items{min-width:100%;}
      table.items th,
      table.items td{padding:6px 4px;font-size:12px}
    }

    /* Responsive header tweaks */
    @media (max-width: 768px) {
      .hero {
        padding: 20px 18px 22px;
      }
      .header-left {
        flex-direction: column;
        align-items: flex-start;
        gap: 10px;
      }
      .header-right {
        margin-left: 0;
        text-align: left;
        align-items: flex-start;
      }
      .header-text h1 {
        font-size: 26px;
        line-height: 1.25;
      }
      .header-text p {
        font-size: 13px;
        max-width: none;
      }
      .header-badge {
        font-size: 12px;
        padding: 6px 12px;
      }
    }

    /* -------- FOOTER BAR ---------- */
    .footer-bar{
      margin-top:18px;
      padding:0 4px 4px;
    }
    .footer-inner{
      background:linear-gradient(90deg,#fdf8ea,#e9f8eb);
      border-radius:22px;
      box-shadow:0 14px 30px rgba(0,0,0,.12);
      padding:16px 20px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:16px;
    }
    .footer-left{
      display:flex;
      align-items:center;
      gap:12px;
      flex:1;
      min-width:0;
    }
    .footer-icon{
      font-size:30px;
      flex-shrink:0;
    }
    .footer-text-wrap{
      min-width:0;
    }
    .footer-title{
      font-weight:700;
      font-size:16px;
      color:#174032;
      margin-bottom:2px;
    }
    .footer-text{
      font-size:13px;
      color:#4c645b;
    }
    .footer-right img{
      display:block;
      max-width:150px;
      border-radius:18px;
      box-shadow:0 8px 18px rgba(0,0,0,.18);
    }

    @media (max-width:768px){
      .footer-inner{
        flex-direction:row;
        align-items:center;
      }
      .footer-right img{
        max-width:110px;
      }
    }
    @media (max-width:540px){
      .footer-inner{
        flex-direction:column;
        align-items:flex-start;
      }
      .footer-right{
        align-self:stretch;
        text-align:center;
        width:100%;
      }
      .footer-right img{
        max-width:150px;
        width:100%;
      }
    }

    /* -------- FLOATING MANGO EMOJIS ---------- */
    .mango-float{
      position:fixed;
      z-index:1;
      font-size:26px;
      opacity:0.55;
      pointer-events:none;
      animation:float-mango 16s linear infinite;
    }
    .mango-float-1{top:10%; left:4%;}
    .mango-float-2{bottom:12%; right:6%; animation-duration:18s;}
    .mango-float-3{top:55%; right:10%; animation-duration:20s;}

    @keyframes float-mango{
      0%{transform:translateY(0);}
      50%{transform:translateY(-14px);}
      100%{transform:translateY(0);}
    }
  </style>
</head>
<body>
  <!-- subtle animated mango emojis -->
  <div class="mango-float mango-float-1">ðŸ¥­</div>
  <div class="mango-float mango-float-2">ðŸ¥­</div>
  <div class="mango-float mango-float-3">ðŸ¥­</div>

  <div class="wrap">
    <div class="card" id="card">
      <header>
        <div class="header-left">
          <div class="emoji">ðŸ¥­</div>
          <div class="header-text">
            <h1>Manage Booking</h1>
            <p>Fresh imported mango boxes â€“ book your pickup or delivery slot in a few easy steps.</p>
          </div>
          <div class="header-right">
            <span><strong>Season Special</strong></span>
            <span>Save $1/box with advance payment</span>
          </div>
        </div>
        <div class="header-hero">
          <img src="images/mango-family-eating.png" alt="Family enjoying mangoes">
        </div>
      </header>

      <main>
        
        <!-- Manage Booking: Find your booking -->
        <div class="card" style="margin-bottom:16px">
          <h2 style="margin:0 0 6px 0">Find your booking</h2>
          <p class="muted" style="margin-top:0">Search using <b>Reference #</b> OR <b>Email</b> OR <b>Phone</b>.</p>

          <div class="grid3">
            <div style="grid-column:1/3">
              <label>Reference # / Email / Phone</label>
              <input type="text" id="searchQuery" placeholder="e.g., 1445 or name@email.com or 647..." />
            </div>
            <div style="display:flex;align-items:flex-end;gap:10px">
              <button type="button" class="primary" id="searchBtn" style="width:100%">Search booking</button>
            </div>
          </div>

          <details style="margin-top:10px">
            <summary class="muted">Set Web App URL (required)</summary>
            <div style="margin-top:10px" class="grid3">
              <div style="grid-column:1/3">
                <label>Apps Script Web App URL (/exec)</label>
                <input type="text" id="webAppUrlInput" placeholder="https://script.google.com/macros/s/AKfycbxb7L6vojLrFNZE2CbvXbxIuBNFLi781nyffc3xSPpHgYD4U_Qq-gJbKWLr5xhbLjlx/exec" />
                <small class="hint">Tip: In Apps Script â†’ Deploy â†’ Manage deployments â†’ Web app â†’ copy URL ending with <b>/exec</b>.</small>
              </div>
              <div style="display:flex;align-items:flex-end">
                <button type="button" class="ghost" id="saveUrlBtn" style="width:100%">Save URL</button>
              </div>
            </div>
          </details>

          <div id="topMsg" class="success" style="display:none;margin-top:12px"></div>
        </div>

        <!-- Existing Booking Preview -->
        <div class="card" id="existingWrap" style="display:none;margin-bottom:16px">
          <h2 style="margin:0 0 8px 0">Existing Booking</h2>
          <div id="lockMsg" class="error" style="display:none;margin-bottom:12px"></div>

          <div class="grid3">
            <div><label>Reference #</label><input id="prevRef" disabled></div>
            <div><label>Invoice #</label><input id="prevInv" disabled></div>
            <div><label>Status</label><input id="prevStatus" disabled></div>

            <div><label>Name</label><input id="prevName" disabled></div>
            <div><label>Email</label><input id="prevEmail" disabled></div>
            <div><label>Phone</label><input id="prevPhone" disabled></div>

            <div><label>Fulfillment</label><input id="prevFulfillment" disabled></div>
            <div><label>Date</label><input id="prevDate" disabled></div>
            <div><label>Time / Window</label><input id="prevTime" disabled></div>

            <div><label>Total</label><input id="prevTotal" disabled></div>
            <div><label>Paid</label><input id="prevPaid" disabled></div>
            <div><label>Balance Due</label><input id="prevBalance" disabled></div>

            <div style="grid-column:1/3"><label>Invoice Link</label><input id="prevInvoiceUrl" disabled></div>
            <div style="grid-column:3/4"><label>Receipt Link</label><input id="prevReceiptUrl" disabled></div>
          </div>
        </div>

        <!-- Edit Area (hidden until booking is editable) -->
        <div id="editArea" style="display:none">
<form id="mangoForm" enctype="multipart/form-data" novalidate method="post" target="mango_hidden_iframe">
          <input type="hidden" name="isoDateTime" value="">
          <input type="hidden" name="requestId" value="">
          <input type="hidden" name="manageAction" id="manageAction" value="updateBooking">
          <input type="hidden" name="referenceNumber" id="referenceNumber" value="">
          <input type="hidden" name="verifyToken" id="verifyToken" value="">
          <input type="hidden" name="prevPaid" id="prevPaidHidden" value="0">
          <input type="hidden" name="receipt_b64" value="">
          <input type="hidden" name="receipt_name" value="">
          <input type="hidden" name="receipt_type" value="">
          <!-- 1) Customer Info -->
          <div class="section">
            <h3>1) Customer Info</h3>
            <div class="grid2">
              <div>
                <label>Full Name <span class="req">*</span></label>
                <input type="text" name="name" required />
              </div>
              <div>
                <label>Email <span class="req">*</span></label>
                <input type="email" name="email" required />
              </div>
              <div>
                <label>Phone Number <span class="req">*</span></label>
                <input type="tel" name="phone" required />
              </div>
              <div>
                <label>Notes (optional)</label>
                <input type="text" name="notes" />
              </div>
            </div>
          </div>

          <!-- 2) Order Details -->
          <div class="section">
            <h3>2) Order Details</h3>
            <div class="mini" style="margin-bottom:6px">
              Prices â€” Alphonso $50 Â· Kesar $40 Â· Badami $35 Â· Langra $30 Â· Dasheri $20
            </div>

            <div class="items-wrap">
              <table class="items" id="itemsTable">
                <thead>
                  <tr>
                    <th style="width:44%">Variety</th>
                    <th style="width:18%">Price/box</th>
                    <th style="width:18%">Boxes</th>
                    <th style="width:16%">Amount</th>
                    <th></th>
                  </tr>
                </thead>
                <tbody id="itemsBody"></tbody>
              </table>
            </div>

            <div class="actions" style="margin-top:10px">
              <button type="button" class="ghost" id="addRowBtn">+ Add variety</button>
            </div>
          </div>

          <!-- 3) Pickup / Delivery -->
          <div class="section">
            <h3>3) Pickup / Delivery</h3>
            <div class="option-group" id="fulfillmentGroup">
              <label class="choice">
                <input type="radio" name="fulfillment" value="Pickup" checked>
                <span class="label-text">Pickup for Free</span>
              </label>
              <label class="choice">
                <input type="radio" name="fulfillment" value="Delivery">
                <span class="label-text">Delivery for extra $10</span>
              </label>
            </div>

            <div class="grid3" style="margin-top:10px">
              <div>
                <label id="dateLabel">Pickup Date <span class="req">*</span></label>
                <select id="dateSelect" name="date" required>
                  <option value="">â€” Select date â€”</option>
                </select>
              </div>

              <div id="timeWrap">
                <label id="timeLabel">Pickup Time Window <span class="req">*</span></label>
                <select id="timeSelect" name="time" required>
                  <option value="">â€” Select time window â€”</option>
                  <option value="09:00">9:00 AM â€“ 12:00 PM</option>
                  <option value="12:00">12:00 PM â€“ 3:00 PM</option>
                  <option value="15:00">3:00 PM â€“ 6:00 PM</option>
                  <option value="18:00">6:00 PM â€“ 8:00 PM</option>
                </select>
              </div>

              <div id="deliveryWindowWrap" class="hidden">
                <label>Delivery Time Window <span class="req">*</span></label>
                <select id="deliveryWindow" name="deliveryWindow">
                  <option value="">â€” Select time window â€”</option>
                  <option value="9:00 AM â€“ 12:00 PM" data-start="09:00">9:00 AM â€“ 12:00 PM</option>
                  <option value="12:00 PM â€“ 3:00 PM" data-start="12:00">12:00 PM â€“ 3:00 PM</option>
                  <option value="3:00 PM â€“ 6:00 PM" data-start="15:00">3:00 PM â€“ 6:00 PM</option>
                  <option value="6:00 PM â€“ 8:00 PM" data-start="18:00">6:00 PM â€“ 8:00 PM</option>
                </select>
              </div>

              <div id="deliveryAddressWrap" class="hidden" style="margin-top:12px">
                            <div style="margin-bottom:10px">
                              <label>Search Address (postal code or start typing)</label>
                              <input type="text" id="deliveryAddressSearch" placeholder="Start typing your address or postal code" autocomplete="off" />
                              <small class="hint">Select your address from the dropdown to auto-fill below. If you can't find it, type manually in the fields below.</small>
                            </div>
                            <div class="grid3">
                              <div>
                                <label>Street Name &amp; Number <span class="req">*</span></label>
                                <input type="text" name="deliveryStreet" id="deliveryStreet" placeholder="123 Main St" />
                              </div>
                              <div>
                                <label>Suite Number</label>
                                <input type="text" name="deliveryUnit" id="deliveryUnit" placeholder="Unit / Apt" />
                              </div>
                              <div>
                                <label>City <span class="req">*</span></label>
                                <input type="text" name="deliveryCity" id="deliveryCity" placeholder="Niagara Falls" />
                              </div>
                            </div>
                            <div class="grid3" style="margin-top:10px">
                              <div>
                                <label>Postal Code <span class="req">*</span></label>
                                <input type="text" name="deliveryPostal" id="deliveryPostal" placeholder="A1A 1A1" />
                              </div>
                              <div>
                                <label>Buzzer Code</label>
                                <input type="text" name="deliveryBuzzer" id="deliveryBuzzer" placeholder="Optional" />
                              </div>
                              <div></div>
                            </div>
                            <small class="hint">Delivery address is required for Delivery orders only.</small>
                          </div>
</div>
          </div>

          <!-- 4) Totals -->
          <div class="section">
            <h3>4) Totals</h3>
            <div class="grid3">
              <div>
                <label>Subtotal (boxes)</label>
                <input type="text" id="subtotalBoxes" disabled />
              </div>
              <div>
                <label>Delivery Fee</label>
                <input type="text" id="deliveryFee" disabled />
              </div>
              <div>
                <label>Advance Discount ($1/box)</label>
                <input type="text" id="advanceDiscount" disabled />
              </div>
              <div>
                <label>Total</label>
                <input type="text" id="grandTotal" disabled />
              </div>
              <div>
                <label>Balance Due</label>
                <input type="text" id="balanceDue" disabled />
              </div>
            </div>
          </div>

          <!-- 5) Payment -->
          <div class="section">
            <h3>5) Payment</h3>
            <div class="option-group" id="advanceGroup">
              <label class="choice">
                <input type="radio" name="advancePayment" value="No" checked>
                <span class="label-text">Pay at pickup/delivery (no discount)</span>
              </label>
              <label class="choice">
                <input type="radio" name="advancePayment" value="Yes">
                <span class="label-text">Pay in advance (save $1 per valid box)</span>
              </label>
            </div>

            <div id="paymentFields" class="hidden" style="margin-top:10px">
              <div class="grid2">
                <div>
                  <label>Amount Paying Now (CAD)</label>
                  <input type="number" name="amount" min="0" step="0.01"
                         placeholder="e.g., full total or partial" />
                </div>
                <div>
                  <label>e-Transfer Email (ID)</label>
                  <input type="email" name="etransferId" placeholder="customer@email.com" />
                </div>
                <div>
                  <label>Payment Date</label>
                  <input type="date" name="paymentDate" />
                </div>
                <div>
                  <label>Payment Time</label>
                  <input type="time" name="paymentTime" />
                </div>
                <div style="grid-column:1/-1">
                  <label>Upload Payment Screenshot (optional)</label>
                  <input type="file" id="receiptFile" name="receipt" accept="image/*,.pdf" />
                  <small class="hint">Images or PDF. Max 10 MB.</small>
                </div>
              </div>
              <div class="hr"></div>
            </div>
          </div>

          <!-- Submit -->
          <div class="actions">
            <button type="submit" class="primary" id="submitBtn">Update Booking</button>
            <button type="button" class="error" id="cancelBtn">Cancel Booking</button>
            <div id="msg" class="mini" aria-live="polite"></div>
          </div>
        </form>
        </div>

      </main>
    </div>

    <!-- Decorative footer bar (will be hidden after successful submit) -->
    <div class="footer-bar">
      <div class="footer-inner">
        <div class="footer-left">
          <div class="footer-icon">ðŸ¥­</div>
          <div class="footer-text-wrap">
            <div class="footer-title">Thank you for sharing the mango joy!</div>
            <div class="footer-text">
              You&rsquo;ll receive an email confirmation once your booking is finalized.
            </div>
          </div>
        </div>
        <div class="footer-right">
          <img src="images/mango-kids-juice.png" alt="Kids happily enjoying mango juice">
        </div>
      </div>
    </div>
  </div>


    <iframe id="mango_hidden_iframe" name="mango_hidden_iframe" class="hidden" title="hidden submit frame"></iframe>
    <div id="server_preview_note" class="mini hidden" style="margin-top:10px">
      <strong>Debug:</strong> The box below shows what the Apps Script server returned after submit (useful if confirmation is not received).
    </div>
  <!-- Google Places API (Address Autocomplete)
       1) Replace YOUR_GOOGLE_MAPS_API_KEY below
       2) Make sure "Places API" is enabled for the key
  -->
  <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDQcPWPhpc_Dlr-d1RWnyOU7Srft-zPZ2o&libraries=places&callback=initAddressAutocomplete"></script>

<script>
/* =========================================================
   Manage Booking Page (GitHub friendly)
   - GET uses JSONP (no CORS issues)
   - UPDATE/CANCEL uses hidden iframe + postMessage
   - Timezone: America/Toronto
   ========================================================= */
(function(){
  const TZ_NAME = 'America/Toronto';
  const LS_KEY = 'MANGO_MANAGE_WEBAPP_URL';

  // --- Elements ---
  const form = document.getElementById('mangoForm');
  const itemsBody = document.getElementById('itemsBody');
  const addRowBtn = document.getElementById('addRowBtn');
  const submitBtn = document.getElementById('submitBtn');
  const cancelBtn = document.getElementById('cancelBtn');

  const editArea = document.getElementById('editArea');
  const existingWrap = document.getElementById('existingWrap');
  const lockMsg = document.getElementById('lockMsg');
  const topMsg = document.getElementById('topMsg');

  const searchQuery = document.getElementById('searchQuery');
  const searchBtn = document.getElementById('searchBtn');
  const webAppUrlInput = document.getElementById('webAppUrlInput');
  const saveUrlBtn = document.getElementById('saveUrlBtn');

  const dateSelect = document.getElementById('dateSelect');
  const timeSelect = document.getElementById('timeSelect');
  const deliveryWindowSelect = document.getElementById('deliveryWindow');
  const deliveryWindowWrap = document.getElementById('deliveryWindowWrap');
  const deliveryAddressWrap = document.getElementById('deliveryAddressWrap');
  const dateLabelEl = document.getElementById('dateLabel');
  const timeLabelEl = document.getElementById('timeLabel');
  const timeWrap = document.getElementById('timeWrap');
  const paymentFields = document.getElementById('paymentFields');

  const prev = {
    ref: document.getElementById('prevRef'),
    inv: document.getElementById('prevInv'),
    status: document.getElementById('prevStatus'),
    name: document.getElementById('prevName'),
    email: document.getElementById('prevEmail'),
    phone: document.getElementById('prevPhone'),
    fulfillment: document.getElementById('prevFulfillment'),
    date: document.getElementById('prevDate'),
    time: document.getElementById('prevTime'),
    total: document.getElementById('prevTotal'),
    paid: document.getElementById('prevPaid'),
    balance: document.getElementById('prevBalance'),
    invoiceUrl: document.getElementById('prevInvoiceUrl'),
    receiptUrl: document.getElementById('prevReceiptUrl'),
  };

  // --- Config (filled from server) ---
  let PRICES = {"Alphonso (Apoos)":50,"Kesar":40,"Badami":35,"Langra":30,"Dasheri":20};
  let LIVE_AVAIL = null;
  let DELIVERY_FEE = 10;
  let TAX_RATE = 0;
  let TAX_ON_DELIVERY = true;
  let ADVANCE_DISCOUNT_PER_BOX = 1.0;

  // Loaded booking info
  let LOADED_BOOKING = null;

  // --- Helpers ---
  function fmt(n){
    const x = Number(n||0);
    return x.toLocaleString('en-CA', { style:'currency', currency:'CAD' });
  }
  function showMsg(text, kind){
    topMsg.style.display = 'block';
    topMsg.className = (kind === 'error') ? 'error' : 'success';
    topMsg.textContent = text;
  }
  function hideMsg(){ topMsg.style.display='none'; topMsg.textContent=''; }
  function setLock(canEdit, msg){
    if (canEdit){
      lockMsg.style.display = 'none';
      lockMsg.textContent = '';
    } else {
      lockMsg.style.display = 'block';
      lockMsg.textContent = msg || 'Sorry, order cannot be changed. We require minimum of 2 days advance notice to update the order.';
    }
  }
  function normalizePhone(s){
    return String(s||'').replace(/\D+/g,'');
  }

  function getWebAppUrl(){
    return (localStorage.getItem(LS_KEY) || '').trim();
  }
  function setWebAppUrl(u){
    localStorage.setItem(LS_KEY, (u||'').trim());
  }

  // JSONP request
  function jsonp(url){
    return new Promise((resolve, reject)=>{
      const cb = 'cb_' + Math.random().toString(36).slice(2);
      const script = document.createElement('script');
      const cleanup = ()=>{
        try{ delete window[cb]; }catch(e){}
        if (script && script.parentNode) script.parentNode.removeChild(script);
      };
      const timer = setTimeout(()=>{ cleanup(); reject(new Error('JSONP_TIMEOUT')); }, 12000);
      window[cb] = (data)=>{ clearTimeout(timer); cleanup(); resolve(data); };
      script.onerror = ()=>{ clearTimeout(timer); cleanup(); reject(new Error('SCRIPT_LOAD_FAILED')); };
      const u = new URL(url);
      u.searchParams.set('cb', cb);
      script.src = u.toString();
      document.body.appendChild(script);
    });
  }

  async function apiGet(action, params){
    const base = getWebAppUrl();
    if (!base || !/\/exec(\?|$)/.test(base)){
      throw new Error('WEB_APP_URL_MISSING');
    }
    const u = new URL(base);
    u.searchParams.set('action', action);
    Object.keys(params||{}).forEach(k=>u.searchParams.set(k, params[k]));
    return await jsonp(u.toString());
  }

  // --- Build Variety Options ---
  function refreshVarietySelects(varieties){
    const selects = itemsBody.querySelectorAll('select.varietySelect');
    selects.forEach(sel=>{
      const current = sel.value;
      sel.innerHTML = '<option value="">Select</option>';
      (varieties||[]).forEach(v=>{
        if (v && v.active){
          const opt = document.createElement('option');
          opt.value = v.name;
          opt.textContent = v.name;
          sel.appendChild(opt);
        }
      });
      if (current) sel.value = current;
    });
  }

  // --- Time/Date availability ---
  function ymd(d){
    const pad=(n)=>String(n).padStart(2,'0');
    return d.getFullYear()+'-'+pad(d.getMonth()+1)+'-'+pad(d.getDate());
  }
  function startOfDay(d){ return new Date(d.getFullYear(), d.getMonth(), d.getDate()); }

  function getSlotsFor_(modeKey, dateStr){
    if (!LIVE_AVAIL || !LIVE_AVAIL[modeKey] || !LIVE_AVAIL[modeKey][dateStr]) return [];
    return LIVE_AVAIL[modeKey][dateStr] || [];
  }

  function buildTimeSelect_(slots){
    timeSelect.innerHTML = '<option value="">Select</option>';
    slots.forEach(s=>{
      const opt = document.createElement('option');
      opt.value = s.label;
      opt.textContent = s.label;
      timeSelect.appendChild(opt);
    });
  }

  function buildDeliveryWindowSelect_(slots){
    deliveryWindowSelect.innerHTML = '<option value="">Select</option>';
    slots.forEach(s=>{
      const opt = document.createElement('option');
      opt.value = s.label;
      opt.textContent = s.label;
      deliveryWindowSelect.appendChild(opt);
    });
  }

  function populateAllowedDates(){
    const isDelivery = form.fulfillment.value === 'Delivery';
    const modeKey = isDelivery ? 'delivery' : 'pickup';

    const avail = (LIVE_AVAIL && LIVE_AVAIL[modeKey]) ? LIVE_AVAIL[modeKey] : {};
    const dates = Object.keys(avail||{}).sort();
    dateSelect.innerHTML = '<option value="">Select</option>';
    dates.forEach(ds=>{
      const opt = document.createElement('option');
      opt.value = ds;
      opt.textContent = ds;
      dateSelect.appendChild(opt);
    });

    // Keep current selected date if exists but not in list
    if (LOADED_BOOKING && LOADED_BOOKING.dateYMD){
      const cur = LOADED_BOOKING.dateYMD;
      if (![...dateSelect.options].some(o=>o.value===cur)){
        const opt = document.createElement('option');
        opt.value = cur;
        opt.textContent = cur + ' (current)';
        dateSelect.appendChild(opt);
      }
      dateSelect.value = cur;
    }

    updateTimeOptions_();
  }

  function updateTimeOptions_(){
    const isDelivery = form.fulfillment.value === 'Delivery';
    const dateStr = (dateSelect && dateSelect.value) ? String(dateSelect.value) : '';
    const slots = isDelivery ? getSlotsFor_('delivery', dateStr) : getSlotsFor_('pickup', dateStr);
    if (isDelivery){
      buildDeliveryWindowSelect_(slots);
      // preserve existing selection if present
      const cur = LOADED_BOOKING ? (LOADED_BOOKING.deliveryWindow || LOADED_BOOKING.time || '') : '';
      if (cur && ![...deliveryWindowSelect.options].some(o=>o.value===cur)){
        const opt = document.createElement('option');
        opt.value = cur;
        opt.textContent = cur + ' (current)';
        deliveryWindowSelect.appendChild(opt);
      }
      if (cur) deliveryWindowSelect.value = cur;
    } else {
      buildTimeSelect_(slots);
      const cur = LOADED_BOOKING ? (LOADED_BOOKING.time || '') : '';
      if (cur && ![...timeSelect.options].some(o=>o.value===cur)){
        const opt = document.createElement('option');
        opt.value = cur;
        opt.textContent = cur + ' (current)';
        timeSelect.appendChild(opt);
      }
      if (cur) timeSelect.value = cur;
    }
  }

  function modeLabels(){
    const isDelivery = form.fulfillment.value === 'Delivery';

    // Toggle address + window
    deliveryAddressWrap.classList.toggle('hidden', !isDelivery);
    deliveryWindowWrap.classList.toggle('hidden', !isDelivery);
    timeWrap.classList.toggle('hidden', isDelivery);

    // Labels
    dateLabelEl.textContent = isDelivery ? 'Delivery Date *' : 'Pickup Date *';
    timeLabelEl.textContent = isDelivery ? 'Pickup Time Window *' : 'Pickup Time Window *'; // keep wording consistent

    populateAllowedDates();
    recalcTotals();
  }

  // --- Line Items ---
  function addRow(variety, qty){
    const tr = document.createElement('tr');

    // Variety
    const tdVar = document.createElement('td');
    const sel = document.createElement('select');
    sel.className = 'varietySelect';
    sel.name = 'itemVariety[]';
    sel.required = true;
    sel.innerHTML = '<option value="">Select</option>';
    tdVar.appendChild(sel);

    // Price
    const tdPrice = document.createElement('td');
    const priceSpan = document.createElement('span');
    priceSpan.className = 'price';
    priceSpan.textContent = fmt(0);
    tdPrice.appendChild(priceSpan);

    // Qty
    const tdQty = document.createElement('td');
    const qtyInput = document.createElement('input');
    qtyInput.type = 'number';
    qtyInput.min = '1';
    qtyInput.step = '1';
    qtyInput.name = 'itemQty[]';
    qtyInput.required = true;
    qtyInput.value = String(qty || 1);
    tdQty.appendChild(qtyInput);

    // Line
    const tdLine = document.createElement('td');
    const lineSpan = document.createElement('span');
    lineSpan.className = 'line';
    lineSpan.textContent = fmt(0);
    tdLine.appendChild(lineSpan);

    // Delete
    const tdDel = document.createElement('td');
    const del = document.createElement('button');
    del.type = 'button';
    del.className = 'deleteRow';
    del.textContent = 'Ã—';
    del.addEventListener('click', ()=>{
      tr.remove();
      recalcTotals();
    });
    tdDel.appendChild(del);

    tr.appendChild(tdVar);
    tr.appendChild(tdPrice);
    tr.appendChild(tdQty);
    tr.appendChild(tdLine);
    tr.appendChild(tdDel);
    itemsBody.appendChild(tr);

    function recalcRow(){
      const v = String(sel.value || '');
      const q = Number(qtyInput.value || 0);
      const p = Number(PRICES[v] || 0);
      priceSpan.textContent = fmt(p);
      lineSpan.textContent = fmt(p*q);
      recalcTotals();
    }
    sel.addEventListener('change', recalcRow);
    qtyInput.addEventListener('input', recalcRow);

    // load options
    refreshVarietySelects(LIVE_AVAIL && LIVE_AVAIL.varieties ? LIVE_AVAIL.varieties : null);

    if (variety) sel.value = variety;
    recalcRow();
  }

  function validLineItems(){
    const items=[];
    const rows=itemsBody.querySelectorAll('tr');
    rows.forEach(tr=>{
      const v = tr.querySelector('select.varietySelect')?.value || '';
      const q = Number(tr.querySelector('input[name="itemQty[]"]')?.value || 0);
      if (v && q>0){
        const p = Number(PRICES[v]||0);
        items.push({ variety:v, q:q, price:p, line:+(p*q).toFixed(2) });
      }
    });
    return items;
  }

  function recalcTotals(){
    const items = validLineItems();
    const subtotal = items.reduce((s,i)=>s+i.line,0);
    const isDelivery = form.fulfillment.value === 'Delivery';
    const delivery = isDelivery ? DELIVERY_FEE : 0;

    const advSelected = form.advancePayment.value === 'Yes';
    const totalQty = items.reduce((s,i)=>s+i.q,0);
    const advanceDiscount = (advSelected && items.length>0) ? (totalQty * ADVANCE_DISCOUNT_PER_BOX) : 0;

    const preTaxSubtotal = Math.max(0, subtotal + delivery - advanceDiscount);
    const taxableBase = TAX_ON_DELIVERY ? preTaxSubtotal : Math.max(0, subtotal - advanceDiscount);
    const tax = TAX_RATE ? +(taxableBase * TAX_RATE).toFixed(2) : 0;
    const total = +(preTaxSubtotal + tax).toFixed(2);

    // Paid: previous + new amount (optional)
    const prevPaid = Number(document.getElementById('prevPaidHidden').value || 0);
    const payNow = Number(form.amount?.value || 0) || 0;
    const paidTotal = +(prevPaid + payNow).toFixed(2);
    const due = +(total - paidTotal).toFixed(2);

    document.getElementById('advanceDiscount').value = fmt(advanceDiscount);
    document.getElementById('subtotalBoxes').value = fmt(subtotal);
    document.getElementById('deliveryFee').value = fmt(delivery);
    document.getElementById('tax').value = fmt(tax);
    document.getElementById('total').value = fmt(total);
    document.getElementById('paid').value = fmt(paidTotal);
    document.getElementById('balanceDue').value = fmt(due);

    // show/hide payment fields when advance payment selected
    const showPay = advSelected && items.length>0;
    if (showPay){
      paymentFields.classList.remove('hidden');
    } else {
      paymentFields.classList.add('hidden');
      if (form.etransferId) form.etransferId.value = '';
      if (form.paymentDate) form.paymentDate.value = '';
      if (form.paymentTime) form.paymentTime.value = '';
      if (receiptInput) receiptInput.value = '';
      if (form.receipt_b64) form.receipt_b64.value = '';
      if (form.receipt_name) form.receipt_name.value = '';
      if (form.receipt_type) form.receipt_type.value = '';
      if (form.amount) form.amount.value = '';
    }
  }

  // --- Receipt file to base64 (same as booking logic) ---
  const receiptInput = document.getElementById('receiptFile');
  if (receiptInput){
    receiptInput.addEventListener('change', async ()=>{
      const file = receiptInput.files && receiptInput.files[0];
      if (!file){
        form.receipt_b64.value = '';
        form.receipt_name.value = '';
        form.receipt_type.value = '';
        return;
      }
      const max = 10 * 1024 * 1024;
      if (file.size > max){
        alert('File too large (max 10 MB).');
        receiptInput.value = '';
        return;
      }
      const b64 = await new Promise((res, rej)=>{
        const r = new FileReader();
        r.onload = ()=>res(String(r.result||'').split(',')[1]||'');
        r.onerror = rej;
        r.readAsDataURL(file);
      });
      form.receipt_b64.value = b64;
      form.receipt_name.value = file.name || 'receipt';
      form.receipt_type.value = file.type || 'application/octet-stream';
    });
  }

  // --- Load config from server ---
  async function loadLiveConfig(){
    const res = await apiGet('getConfig', {});
    if (!res || !res.ok) return;
    DELIVERY_FEE = Number(res.deliveryFee||DELIVERY_FEE);
    TAX_RATE = Number(res.taxRate||TAX_RATE);
    TAX_ON_DELIVERY = (res.taxOnDelivery !== false);
    ADVANCE_DISCOUNT_PER_BOX = Number(res.advanceDiscountPerBox||ADVANCE_DISCOUNT_PER_BOX);

    if (Array.isArray(res.varieties)){
      PRICES = {};
      res.varieties.forEach(v=>{
        PRICES[v.name] = Number(v.price||0);
      });
    }
    LIVE_AVAIL = { pickup: res.availability?.pickup || {}, delivery: res.availability?.delivery || {}, varieties: res.varieties || [] };

    refreshVarietySelects(res.varieties||[]);
    populateAllowedDates();
    recalcTotals();
  }

  // --- Search Booking ---
  async function searchBooking(silent){
    hideMsg();
    editArea.style.display = 'none';
    existingWrap.style.display = 'none';
    LOADED_BOOKING = null;

    const q = String(searchQuery.value||'').trim();
    if (!q){
      showMsg('Enter Reference #, Email, or Phone to search.', 'error');
      return;
    }
    try{
      searchBtn.disabled = true;
      if (!silent) showMsg('Searching booking...', '');
      const res = await apiGet('searchBooking', { q });
      if (!res || !res.ok){
        showMsg(res?.message || 'Booking not found.', 'error');
        return;
      }
      const b = res.booking;
      LOADED_BOOKING = b;

      // Fill preview
      existingWrap.style.display = 'block';
      prev.ref.value = b.referenceNumber || '';
      prev.inv.value = b.invoiceNumber || '';
      prev.status.value = b.status || '';
      prev.name.value = b.name || '';
      prev.email.value = b.email || '';
      prev.phone.value = b.phone || '';
      prev.fulfillment.value = b.fulfillment || '';
      prev.date.value = b.dateYMD || '';
      prev.time.value = (b.fulfillment === 'Delivery') ? (b.deliveryWindow || b.time || '') : (b.time || '');
      prev.total.value = fmt(b.total || 0);
      prev.paid.value = fmt(b.paid || 0);
      prev.balance.value = fmt(b.balanceDue || 0);
      prev.invoiceUrl.value = b.invoiceUrl || '';
      prev.receiptUrl.value = b.receiptUrl || '';

      // Hidden for update calculations
      document.getElementById('referenceNumber').value = b.referenceNumber || '';
      document.getElementById('verifyToken').value = String(q);
      document.getElementById('prevPaidHidden').value = String(Number(b.paid||0));

      // Lock
      const canEdit = !!(b.lock && b.lock.canEdit);
      setLock(canEdit, b.lock?.message || '');
      if (!canEdit){
        showMsg('Booking loaded (view only).', '');
        return;
      }

      // Load config so date/time/options are available
      await loadLiveConfig();

      // Prefill form
      if (form.fullName) form.fullName.value = b.name || '';
      if (form.email) form.email.value = b.email || '';
      if (form.phone) form.phone.value = b.phone || '';
      if (form.notes) form.notes.value = b.notes || '';

      // Items
      itemsBody.innerHTML = '';
      (b.items && b.items.length ? b.items : [{variety:'', qty:1}]).forEach(it=>{
        addRow(it.variety || '', Number(it.qty||1));
      });

      // Fulfillment
      const f = b.fulfillment || 'Pickup';
      form.fulfillment.value = f;
      modeLabels();

      // Address
      if (form.deliveryStreet) form.deliveryStreet.value = b.deliveryStreet || '';
      if (form.deliveryUnit) form.deliveryUnit.value = b.deliveryUnit || '';
      if (form.deliveryCity) form.deliveryCity.value = b.deliveryCity || '';
      if (form.deliveryPostal) form.deliveryPostal.value = b.deliveryPostal || '';
      if (form.deliveryBuzzer) form.deliveryBuzzer.value = b.deliveryBuzzer || '';

      // Date/Time/Window
      if (b.dateYMD){
        dateSelect.value = b.dateYMD;
        updateTimeOptions_();
      }
      if (f === 'Delivery'){
        if (b.deliveryWindow) deliveryWindowSelect.value = b.deliveryWindow;
      } else {
        if (b.time) timeSelect.value = b.time;
      }

      // Advance payment
      form.advancePayment.value = (String(b.advancePayment||'').toLowerCase()==='yes') ? 'Yes' : 'No';
      // clear pay now
      if (form.amount) form.amount.value = '';
      if (form.etransferId) form.etransferId.value = '';
      if (form.paymentDate) form.paymentDate.value = '';
      if (form.paymentTime) form.paymentTime.value = '';
      if (form.receipt_b64) form.receipt_b64.value = '';
      if (form.receipt_name) form.receipt_name.value = '';
      if (form.receipt_type) form.receipt_type.value = '';
      if (receiptInput) receiptInput.value = '';

      // Show edit area
      editArea.style.display = 'block';
      recalcTotals();

      showMsg('Booking loaded. You can update or cancel this booking.', 'success');
    } catch(e){
      console.error(e);
      if (String(e.message||'') === 'WEB_APP_URL_MISSING'){
        showMsg('Web App URL is missing or not /exec. Please set it under "Set Web App URL (required)".', 'error');
      } else {
        showMsg('Failed to load from server. Please confirm your Web App URL is correct and deployed as /exec.', 'error');
      }
    } finally {
      searchBtn.disabled = false;
    }
  }

  // --- Update / Cancel ---
  function submitManage(action){
    if (!LOADED_BOOKING || !LOADED_BOOKING.referenceNumber){
      showMsg('Search and load a booking first.', 'error');
      return;
    }
    document.getElementById('manageAction').value = action;
    const base = getWebAppUrl();
    if (!base){
      showMsg('Web App URL is missing. Please set it first.', 'error');
      return;
    }
    form.action = base + '?action=' + encodeURIComponent(action);
    form.submit();
    showMsg(action === 'cancelBooking' ? 'Submitting cancellation...' : 'Submitting update...', '');
  }

  // Listen for iframe results (postMessage from server)
  window.addEventListener('message', (ev)=>{
    const d = ev && ev.data;
    if (!d || d.type !== 'manageResult') return;
    if (d.ok){
      showMsg(d.message || 'Thank you for your business. Your booking was updated successfully.', 'success');
      editArea.style.display = 'none';
      if (d.referenceNumber){
        searchQuery.value = d.referenceNumber;
        searchBooking(true);
      }
    } else {
      showMsg(d.message || 'Error: unable to process your request.', 'error');
    }
  });

  // --- Events ---
  saveUrlBtn.addEventListener('click', ()=>{
    const u = String(webAppUrlInput.value||'').trim();
    if (!u){
      showMsg('Paste your Apps Script Web App URL first.', 'error');
      return;
    }
    setWebAppUrl(u);
    showMsg('Web App URL saved. Now search your booking.', 'success');
  });

  searchBtn.addEventListener('click', ()=>searchBooking(false));
  searchQuery.addEventListener('keydown', (e)=>{
    if (e.key === 'Enter'){ e.preventDefault(); searchBooking(false); }
  });

  addRowBtn.addEventListener('click', ()=>addRow('', 1));

  document.querySelectorAll('input[name="fulfillment"]').forEach(r=>r.addEventListener('change', modeLabels));
  document.querySelectorAll('input[name="advancePayment"]').forEach(r=>r.addEventListener('change', recalcTotals));
  dateSelect.addEventListener('change', ()=>{ updateTimeOptions_(); recalcTotals(); });
  timeSelect.addEventListener('change', recalcTotals);
  deliveryWindowSelect.addEventListener('change', recalcTotals);
  if (form.amount) form.amount.addEventListener('input', recalcTotals);

  // Update button (form submit) -> updateBooking
  form.addEventListener('submit', (e)=>{
    // prevent normal booking submit logic: manage only
    e.preventDefault();
    submitManage('updateBooking');
  });

  cancelBtn.addEventListener('click', ()=>{
    if (!LOADED_BOOKING) { showMsg('Search and load a booking first.', 'error'); return; }
    if (!confirm('Cancel this booking? This will mark status as Cancelled.')) return;
    submitManage('cancelBooking');
  });

  // Init
  const saved = getWebAppUrl();
  if (saved) webAppUrlInput.value = saved;

  editArea.style.display = 'none';
  existingWrap.style.display = 'none';
  setLock(true,'');
  // Ensure at least one blank row exists if user opens edit area later
  itemsBody.innerHTML = '';
  addRow('', 1);
  recalcTotals();
})();
</script>

</body>
</html>
